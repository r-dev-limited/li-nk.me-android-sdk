name: Release

on:
  push:
    tags:
      - "v*"
      - "android-v*"

permissions:
  contents: read

jobs:
  release:
    name: Release Android SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/android
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag matches Gradle version
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"

          if [[ "$TAG" == android-v* ]]; then
            TAG_VERSION="${TAG#android-v}"
          elif [[ "$TAG" == v* ]]; then
            TAG_VERSION="${TAG#v}"
          else
            echo "Tag '${TAG}' must start with 'v' or 'android-v'." >&2
            exit 1
          fi

          GRADLE_VERSION=$(python3 - <<'PY'
import pathlib, re
content = pathlib.Path("linkmekit/build.gradle.kts").read_text()
match = re.search(r'version\s*=\s*"([^"]+)"', content)
if not match:
    raise SystemExit("Unable to find version inside linkmekit/build.gradle.kts")
print(match.group(1))
PY
)

          echo "Tag version: ${TAG_VERSION}"
          echo "Gradle version: ${GRADLE_VERSION}"

          if [[ "${TAG_VERSION}" != "${GRADLE_VERSION}" ]]; then
            echo "Tag (${TAG_VERSION}) does not match Gradle version (${GRADLE_VERSION})." >&2
            exit 1
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          build-root-directory: sdks/android

      - name: Run lint, tests, and build release
        shell: bash
        run: |
          ./gradlew --no-daemon clean \
            :linkmekit:lint \
            :linkmekit:testDebugUnitTest \
            :linkmekit:assembleRelease \
            :linkmekit:publishToMavenLocal

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-sdk-${{ github.ref_name }}
          if-no-files-found: error
          path: |
            sdks/android/linkmekit/build/outputs/aar/linkmekit-release.aar
            sdks/android/linkmekit/build/publications/**
